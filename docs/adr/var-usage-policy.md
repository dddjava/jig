# `var`（ローカル変数型推論）の使用方針

## 状況 (Context)
Java 10 以降では、ローカル変数の宣言に `var` を使用することで型推論が可能です。
`var` は可読性の向上や記述の簡潔化に寄与しますが、むやみに使用すると型の意図が不明瞭になり、レビューや保守における理解コストが増大します。

本プロジェクトでは、ドメインモデルとアプリケーション層の意図を明確にすることを重視しており、`var` の利用に関して統一的な方針を定めます。

## 決定 (Decision)
- `var` は可読性を損なわない範囲で使用します。
- 初期化式から型が直感的に明らかな場合に限り `var` を使用できます。
- 型が重要な意味（ドメインの意図や API 契約）を伝える場面で、変数名で十分に説明できない場合は、明示的な型を使用します。
- 長大なジェネリクスを省略する目的での `var` の使用は許容しません。ジェネリクスの使い方を見直します。

## トレードオフ (Trade-Offs)
- メリット
  - 冗長な型記述の削減による集中度の向上
- デメリット
  - 初期化式から型が読み取りにくい場合に理解コストが増加
  - IDE 依存の読み方になり、レビュー時の一目での理解性が下がる可能性

## 採用ガイドライン (Guidelines)
1. 使用可能な範囲
   - 初期化式が以下のいずれかで「型が明白」な場合は `var` を使用してよい。
     - `new` によるコンストラクタ呼び出し（例: `new ArrayList<>(...)`、`new Items(...)`）
     - 明確に命名されたファクトリメソッドやスタティックメソッド（例: `List.of(...)`, `Optional.of(...)`, `Path.of(...)`）
     - 型名とローカル変数名が同一（例: `JigType jigType = jigType(jigRepository);`）
   - 例外: `try-with-resources` のリソース変数についても上記に準ずる。型が明白なら `var` を許容。

2. 使用を避ける（明示的な型を記載する）
   - 初期化式が `null` の場合、三項演算子や条件分岐で複数候補の型があり得る場合
   - 数値/文字列リテラルのみの初期化で意図する型が曖昧になり得る場合（例: `var n = 0;` は `int` だが意味が伝わらない）
   - メソッド戻り値の型が文脈から推測しにくい場合や、型名自体がドメインの意図を伝える場合（例: `Money`, `UserId`, `OrderLines` など）
   - ワイルドカードや複雑なジェネリクスで、推論結果が読み手に直感的でない場合
   - API 境界やドメインロジックの核心で、型を明示することが設計意図を伝えるのに有効な場合
   - IDEの機能で `var` の型を表示したくなるような場合（型を表示する機能は無効化することを推奨する）
   - 1メソッドのほとんどで明示的な型を使用している場合（混在によるノイズ増大を避ける）

3. コレクション・ストリーム
   - 一時的な可変コレクションの生成など、意図が明確な場合に `var` を使用してよい。
   - コレクションの要素型が読み取りにくい場合は、明示的な型を使用する。
   - for-each での `var` は、反復対象の型が直前で明らかな場合のみ許容。曖昧な場合は明示する。

4. ラムダパラメータ
   - Java 11 以降の「ラムダパラメータでの `var`」は、アノテーション付与などの必要がある場合に限り使用を許可します。
   - それ以外では、従来どおり省略形（型推論）を使用し、`var` は不要です。

5. テストコード
   - テストでは読みやすさを最優先し、`var` の使用範囲を本方針と同等またはやや緩やかに扱って構いません。
   - ただし曖昧さや意図不明瞭さを生む場合は型を明示すること。

6. 命名
   - `var` は型名を隠すため、変数名で役割と意図を十分に表現すること。

7. 対称性
   - `var` は 1 で示すように「使用してよい」であるが、同一メソッド内では *必ず* 同一条件での使用／不使用は統一すること。
   - 可能な限り、同一クラス内でも同一条件での使用／不使用は統一すること。

## 実装例
### 許容（Good）
```java
// new による型が明確
var list = new ArrayList<Item>(items);

// 明確なファクトリメソッド
var path = Path.of("/tmp/file.txt");

// 終端操作から自明なストリームの結果
var sortedList = items.stream().sorted().toList();

// 型名とローカル変数名が同じ場合は var を使用する
var jigType = jigType(jigRepository);
```

### 非推奨 / 禁止（Avoid）
```java
// 意図する型が読み取りにくい
var n = 0;               // 何の数か不明
var value = factory();   // 戻り値の型が文脈から不明確

// null 初期化や条件で型が曖昧
var x = null;            // 型が決まらない
var y = cond ? a() : b();// a(), b() の戻り値が異なる型かもしれない

// ドメインの意図を伝えるべき箇所
var amount = calculateTotal(); // Money など、型名が意味を持つなら明示する
```

## 結論 (Consequences)
- `var` の利用基準を明確化することで、可読性と簡潔性のバランスをとりつつ、設計意図の伝達を維持できます。
- ドメインにおける重要な型は明示し、補助的で型が自明な箇所では `var` による記述の簡潔化を許容します。
- プロジェクト内で一貫したコーディングスタイルを促進します。
